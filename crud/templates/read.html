{% extends 'core/base.html' %}

{% load static %}

{% block main_content %}
<style>

td.invisible {
    display: none;
}

th.invisible {
    display: none;
}

.ellipses {
  display: inline;
}

.contenido-oculto {
  display: none;
}

.mostrar-mas {
    color: blue;
    cursor: pointer;
}

.mostrar-mas:hover {
    text-decoration: underline;
}
.resaltado {
    background-color: orange;
}
th {
        font-size: 13px; /* Puedes ajustar el tamaño de la fuente según tu preferencia */
        font-weight: bold; /* Opcional: hacer el texto en negrita */
    }
</style>
<section class="container">
    <br>
    <div class="row">
        
        <div style="display: flex; justify-content: center; margin: 0 auto;">
            <table id="tabla_fichas" class="display table table-striped table-bordered table-sm" style="width: 110%;">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Fecha de Ingreso</th>
                        <th>Fecha de Ingreso a SECPLA</th>
                        <th style="width: 150px;">Nombre y Apellido O Razón Social</th>
                        <th>N° Folio</th>
                        <th>Estado</th>
                        <th style="width: 280px;">Acciones</th>
                        <th class="invisible">Solicitud</th>
                        <th >Respuesta</th>
                        <th >Fecha Limite</th>


                    </tr>
                </thead>
                <tbody>
                    {% for Solicitud, respuesta in solicitud_respuesta_list %}
                    <tr>
                            <td>{{ Solicitud.id }}</td>
                            <td>{{ Solicitud.fecha_i_t }}</td>
                            <td>{{ Solicitud.fecha_i_au }}</td>
                            <td>{{ Solicitud.nombre_o_razon_social }}  {{ Solicitud.primer_apellido }}</td>
                            <td>{{ Solicitud.N_transparencia }}</td>
                            <td>{{ Solicitud.estado }}</td>
                            


                            <td> 
                                <a href="#" class="btn btn-purple preview-link" data-id="{{ Solicitud.id }}" style="margin-top: 10px; margin-bottom: 10px;">Ver Solicitud</a>
                            
                                {% if departamento.nombre_departamento == 'ADMIN' and Solicitud.estado == "Sin responder" %}
                                <a href="{% url 'respuesta' Solicitud.id %}" class="btn btn-purple" style="margin-top: 10px; margin-bottom: 10px;">Propuesta de respuesta</a>
                                {% endif %}
                                
                                {% if Solicitud.estado == "Respondida" %}
                                    <a href="#" class="btn btn-purple preview-res-link" data-id="{{ respuesta.id }}" style="margin-top: 10px; margin-bottom: 10px;">Ver Propuesta Respuesta</a>
                                   
                                    {% if departamento.nombre_departamento == 'ADMIN'%}

                                    <a href="#" class="btn btn-purple preview-res-link" data-id="{{ respuesta.id }}" style="margin-top: 10px; margin-bottom: 10px;">P-Editar Propuesta respuesta</a>
                                
                                    <a href="#" class="btn btn-purple preview-res-link" data-id="{{ respuesta.id }}" style="margin-top: 10px; margin-bottom: 10px;">P-Prórroga</a>
                                    {% endif %}


                                {% endif %}
                            </td>
                            

                            <td class="invisible">{{ Solicitud.solicitud_text }}</td>
                            <td class="respuesta">{{ respuesta.respuesta }}</td>
                            <td>{{ Solicitud.fecha_limite }}</td>




                        </tr>
                    {% empty %}
                        <tr>
                            <td>No hay datos</td>
                            <td>No hay datos</td>
                            <td>No hay datos</td>
                            <td>No hay datos</td>
                            <td>No hay datos</td>

                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <!-- Modal para mostrar la vista previa -->
        <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #c2c5c3;">
                    <h5 class="modal-title" style="color: white;" id="previewModalLabel">Vista previa de solicitud</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="previewData">
                    <!-- Aquí se mostrará la información de la solicitud -->
                </div>
            </div>
        </div>
        </div>


</section>
{% endblock main_content %}

{% block custom_js %}
<script>
$(document).ready(function () {
    var tabla = $('#tabla_fichas').DataTable({
        language: {
            url: '//cdn.datatables.net/plug-ins/1.12.1/i18n/es-CL.json'
        },
        
        initComplete: function () {
            $("#tabla_fichas").show();
            $('.respuesta').each(function () {
                var contenido = $(this).text().trim();
                if (contenido.length > 250) {
                    var recortado = contenido.substring(0, 250);
                    var restante = contenido.substring(250);
                    $(this).html(recortado + '<span class="mostrar-mas">... <a href="#" class="enlace-mostrar">Mostrar más</a></span><span class="texto-restante" style="display:none;">' + restante + ' <a href="#" class="enlace-ocultar">Mostrar menos</a></span>');
                }
            });
        },
        // rowCallback para resaltar la palabra buscada
        "rowCallback": function (row, data, index) {
    var searchTerm = $('#tabla_fichas_filter input').val().trim();
    if (searchTerm !== '') {
        var regex = new RegExp('(' + searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&') + ')', 'ig');
        $(row).find('.respuesta').each(function() {
            var originalText = $(this).data('original-text');
            if (!originalText) {
                originalText = $(this).text();
                $(this).data('original-text', originalText);
            }
            $(this).html(originalText.replace(regex, '<span class="resaltado">$1</span>'));
        });
    } else {
        $(row).find('.respuesta').each(function() {
            var originalText = $(this).data('original-text');
            if (originalText) {
                $(this).html(originalText);
            }
        });
    }
}
    });

    // Filtrar la tabla cuando se realiza una búsqueda
    $('#tabla_fichas_filter input').on('keyup', function () {
        tabla.search(this.value).draw();
    });

    // Delegación de eventos para mostrar y ocultar más texto
    $('#tabla_fichas tbody').on('click', '.enlace-mostrar', function (e) {
        e.preventDefault();
        $(this).closest('.respuesta').find('.texto-restante').show();
        $(this).closest('.mostrar-mas').hide();
    });

    $('#tabla_fichas tbody').on('click', '.enlace-ocultar', function (e) {
        e.preventDefault();
        $(this).closest('.respuesta').find('.texto-restante').hide();
        $(this).closest('.respuesta').find('.mostrar-mas').show();
    });
});
</script>
    
    

<script>
var previewLinks = document.querySelectorAll('.preview-link');
previewLinks.forEach(function(link) {
    link.addEventListener('click', function(event) {
        event.preventDefault(); // Evitar el comportamiento predeterminado del enlace

        var solicitudId = this.getAttribute('data-id'); // Obtener el ID de la solicitud

        // Hacer una solicitud AJAX a la vista 0de Django para obtener los datos de la solicitud
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/accion/vista_previa_solicitud/' + solicitudId, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                var data = JSON.parse(xhr.responseText);

                // Construir el texto con los datos de la solicitud
                var previewDataText = 'Fecha de la Solicitud: ' + data.fecha_i_t + '\n' +
                                      'Fecha de la Asesoría Urbana: ' + data.fecha_i_au + '\n' +
                                      'N° de Transparencia: ' + data.N_transparencia + '\n' +
                                      'Dirigido a: ' + data.dirigido + '\n' +
                                      'Región: ' + data.region + '\n' +
                                      'Recepción: ' + data.recepcion + '\n' +
                                      'Correo Electrónico: ' + data.email + '\n' +
                                      'Texto de la Solicitud: ' + data.solicitud_text + '\n' +
                                      'Observaciones: ' + data.observaciones + '\n' +
                                      'Soporte: ' + data.soporte + '\n' +
                                      'Formato: ' + data.formato + '\n' +
                                      'Solicitante Inicia Sesión: ' + (data.solicitante_inicio_seccion ? 'Sí' : 'No') + '\n' +
                                      'Forma de Recepción: ' + data.forma_de_recepccion + '\n' +
                                      'Otra Forma de Entrega: ' + data.otra_forma_De_entrega + '\n' +
                                      'Persona: ' + data.persona + '\n' +
                                      'Nombre o Razón Social: ' + data.nombre_o_razon_social + '\n' +
                                      'Primer Apellido: ' + data.primer_apellido + '\n' +
                                      'Segundo Apellido: ' + data.segundo_apellido + '\n';

                var previewDataElement = document.getElementById('previewData');
                previewDataElement.innerText = previewDataText;

                // Si hay un archivo adjunto, agregar enlace de descarga
                if (data.archivo_adjunto_url) {
                    previewDataElement.innerHTML += '<br><a href="' + data.archivo_adjunto_url + '" download>Descargar Archivo Adjunto</a>';
                }

                $('#previewModal').modal('show'); // Mostrar el modal utilizando jQuery
            }
        };
        xhr.send();
    });
});
</script>

<script>
    var previewLinks = document.querySelectorAll('.preview-res-link');
    previewLinks.forEach(function(link) {
        link.addEventListener('click', function(event) {
            event.preventDefault(); // Evitar el comportamiento predeterminado del enlace
    
            var solicitudId = this.getAttribute('data-id'); // Obtener el ID de la solicitud
    
            // Hacer una solicitud AJAX a la vista de Django para obtener los datos de la solicitud
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/accion/vista_previa_respuesta/' + solicitudId, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var data = JSON.parse(xhr.responseText);
                    // Construir el texto con los datos de la solicitud
                    var previewDataText = 'Respuesta: ' + data.respuesta + '\n'+
                                          'Fecha DAJ: ' + data.fecha_daj + '\n';

                    var previewDataElement = document.getElementById('previewData');
                    previewDataElement.innerText = previewDataText;
    
                    // Si hay un archivo adjunto, agregar enlace de descarga
                    if (data.archivo_adjunto_url) {
                        previewDataElement.innerHTML += '<br><a href="' + data.archivo_adjunto_url + '" download>Descargar Archivo Folio</a>';
                    }
                    if (data.archivo_adjunto_url_2) {
                        previewDataElement.innerHTML += '<br><a href="' + data.archivo_adjunto_url_2 + '" download>Descargar Archivo Propuesta de respuesta</a>';
                    }

                    if (data.archivo_adjunto_url_3) {
                        previewDataElement.innerHTML += '<br><a href="' + data.archivo_adjunto_url_3 + '" download>Descargar Archivo Adjunto (Planos, Decretos,PDF, etc)</a>';
                    }

    
                    $('#previewModal').modal('show'); // Mostrar el modal utilizando jQuery
                }
            };
            xhr.send();
        });
    });
</script>

    
{% endblock custom_js %}
